@page "/importorders/edit/{id:int?}"
@using WarehouseX.DTOs
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@inject WarehouseX.Services.IImportOrderService ImportOrderService
@inject WarehouseX.Services.IProductService ProductService
@inject NavigationManager Navigation

@rendermode InteractiveServer

<PageTitle>Edit Import Order</PageTitle>

<EditForm Model="order" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="mb-2">
        <label>Date</label>
        <InputDate class="form-control" @bind-Value="order.ImportDate" />
    </div>
    <div class="mb-2">
        <label>Supplier</label>
        <InputText class="form-control" @bind-Value="order.SupplierName" />
    </div>
    <div class="mb-2">
        <label>Description</label>
        <InputText class="form-control" @bind-Value="order.Description" />
    </div>
    <div class="mb-2">
        <label>Items</label>
        <button class="btn btn-sm btn-success mb-1" @onclick="AddItem" type="button">Add Item</button>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in order.Items)
                {
                    <tr>
                        <td>
                            <select class="form-select" @bind="item.ProductId">
                                <option value="">Select...</option>
                                @foreach (var p in products)
                                {
                                    <option value="@p.ProductId">@p.Name</option>
                                }
                            </select>
                        </td>
                        <td>
                            <InputNumber class="form-control" @bind-Value="item.Quantity" />
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveItem(item)" type="button">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <button class="btn btn-success me-2" type="submit">Save</button>
    <button class="btn btn-secondary" type="button" @onclick="GoBack">Cancel</button>
</EditForm>

@code {
    [Parameter] public int? id { get; set; }
    private ImportOrderDTO order = new();
    private List<ProductDTO> products = new();

    protected override async Task OnInitializedAsync()
    {
        products = (await ProductService.GetAllAsync()).ToList();
        if (id == null)
        {
            order = new ImportOrderDTO { ImportDate = DateTime.Today };
        }
        else
        {
            var o = await ImportOrderService.GetByIdAsync(id.Value);
            if (o != null)
                order = o;
        }
    }

    private void AddItem()
    {
        order.Items.Add(new ImportOrderItemDTO());
    }

    private void RemoveItem(ImportOrderItemDTO item)
    {
        order.Items.Remove(item);
    }

    private async Task HandleValidSubmit()
    {
        if (id == null)
            await ImportOrderService.AddAsync(order);
        else
            await ImportOrderService.UpdateAsync(order);
        GoBack();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/import-orders");
    }
}
